\chapter{Introduction to P2P networks and their application to blockchains}

\label{Chapter02_Intro_P2P}

A peer-to-peer protocol is an essential part of a cryptocurrency.
The design goal of a cryptocurrency is open participation.
Every user must be able to verify the validity of the blockchain state.
Consequently, every user must be able to obtain the current state of the system from other peers.
\footnote{Zero-knowledge cryptography alleviates this requirement for some blockchain protocols.} % cite Coda

One of the design goals of ARPANET, the precursor to the Internet established in 1969, was reliability.
The network was designed to survive even if a large share of nodes were lost.
The key design decision enabling this was packet switching.
In contrast to earlier circuit switching networks, like the telephone network, where a dedicated end-to-end channel was assigned to any pair of currently connected parties, Internet protocols embrace the uncertainty stemming from connecting heterogeneous, geographically distributed computer networks.
Data is divided into packets, which are routed independently along various networks routes, to be re-combined at the receiving end.
No central server is responsible for routing: individual routers take decisions based on their view of the network.
This idea, counter-intuitive at the time, enabled the Internet to grow by many orders of magnitude, and still be resilient to disruptions.

As the Internet gained adoption with the general public in the 1990s, file-sharing networks emerged.
They allowed users to share large files very efficiently without relying on any one server.
The primary example of such networks is BitTorrent.
Over the years, it has shown impressive resiliency, surviving multiple attempts by law enforcement to shut individual BitTorrent trackers down due to them facilitating illegal content sharing.
Therefore it may be considered a precursor for Bitcoin.

BitTorrent resiliency remains an inspiration for cryptocurrency designers.
Satoshi Nakamoto, the creator of Bitcoin, wrote: "Governments are good at cutting off the heads of a centrally controlled networks like Napster, but pure P2P networks like Gnutella and Tor seem to be holding their own."~\cite{Nakamoto2008}.
\todo{Make an chapter or part epigraph?}
However, the goal of disseminating cryptocurrency data has important distinctions compared to file-sharing.

This introductory Chapter motivates our study of privacy issues of Bitcoin's P2P protocol and puts it in a historical context.


\section{Background on P2P networks}

As any network, computer networks comprise of nodes.
An important question that network architects have to face is whether nodes are equal in their functions, or all nodes can perform the common set of tasks.

The former approach emphasizes efficiency.
We can draw an analogy with economic development of humanity, where the total wealth grows hand in hand with the division of labor.
Humans specialize in narrow tasks, getting very efficient at their professions, and exchange the fruit of their labor with others.
In network architecture, dedicating special nodes to perform operations such as coordination or data hosting brings efficiency.
Specialized nodes, can be implemented using optimized hardware (servers), maintained in specialized facilities (data centers) by professional technicians, take advantage of the economy of scale, and so on.

However, specialization harms resiliency.
If only a small group of people are responsible for a critically important set of functions, it only takes a relatively small number of them getting sick for adverse effects to propagate to the entire society.
In networking, likewise, if a dedicated group of servers maintains critical functions, it only takes one successful targeted attack, physical or by means of malware, to disrupt the whole network.

Keeping this trade-off in mind, let us review the development of P2P networks from file-sharing to blockchains.


\subsection{Early file-sharing networks}

The Internet has gained momentum in the developed world, with regular people and businesses exposed for the first time to the possibility of sharing data across the world with little to no pre-moderation.
Not surprisingly, the most common type of data people wanted to share media content such as movies and music.

File-sharing networks emerged in late 1990s to satisfy this demand, often by illegal means.
The two important early P2P networks are Napster and Gnutella~\cite{Saroiu2003}.
Napster -- the first successful music-centered file-sharing network -- was launched in 1999.
Having quickly gained millions of users, it drew attention from law enforcement, and was shut down in 2001.

An important point in the context of this thesis is that it was \textit{possible} to shut the network down.
Napster users were downloading content from each others' computers, but a central server was responsible for content search.
Without it, the network could not operate.

The Napster story emphasized the dilemma that P2P networks face.
In a file-sharing network, someone has to host the files.
If there is no central server, regular users must to this.
But regular users simply want to download a movie and watch it.
They do not want to take deliberate action "for the good of the network".
And as P2P network's value grows with the network effect, it is very important to make it simple for end users to use, but still make them contribute, maybe even without realizing it.

We can divide the task of file-sharing into two sub-tasks: locating a file and downloading it.
One nay argue that as long as a user knows where the required file is located, it is only a technical matter to download it efficiently.
A more crucial task, which Napster failed to implement in a resilient fashion, is content discovery.

Using a server for this task introduces a central point of failure and renders the network vulnerable.
Gnutella, on the other hand, went to the other extreme and used a flooding technique.
A user would forward the query to its neighbors, each of which would either reply with the requested content, or forward the query further.
While this approach has no single point of failure, it is significantly less efficient.


\subsubsection{BitTorrent}

BitTorrent~\cite{Pouwelse2005}, developed and launched in 2001, learned the lessons from both Napster and Gnutella.
Its design strikes a good balance between efficiency and resilience, without making user experience too unwelcoming.

As in other file-sharing P2P networks, users in BitTorrent download files from each other.
There are, however, multiple ways to locate the files.
One common way is \textit{torrent files}, which are distributed by specialized web servers -- \textit{trackers}.
A torrent file contains information about the file, its checksum, and addresses of some peers that likely host it.
This method does not make the whole network dependent on a single server, but a certain degree of centralization remains.
Alternatively, BitTorrent users may locate files with \textit{magnet links}, which utilize a modification of Kademlia~\cite{Maymounkov2002} -- a distributed hash table.

A distributed hash table (DHT) is a method of addressing content in a P2P network.
It randomly distributes content among nodes and allows for efficient querying.
It also requires only a minimal network restructuring when nodes leave or join.


\subsection{Incentives}

P2P file-sharing networks depended to a large extent on the users' goodwill.
They provided little monetary incentive for users to distribute files, let alone upload new content onto the network.
However, in contradiction to naive economical models, file-sharing networks gave birth to the \textit{warez scene} -- a community of people sharing content, mostly illegally, but with altruistic rather than profit-seeking motivations~\cite{Rehn2004}.
Regular users of file-sharing users were encouraged to share by trackers (in case of BitTorrent): for instance, by enforcing a ratio between what a user downloaded and uploaded.
However, such metrics are inherently vulnerable, as file-sharing network lack a strong identity system.
A tracker can force upload ratios for each account, but preventing users from signing up multiple times is tricky.
Protecting against such cheating -- Sybil attacks -- inevitably required an identity server, which would introduce a central point of failure.

Bitcoin solved the problem of Sybil protection in a decentralized network by using \textit{proof of work}.
\todo{Where should we introduce Bitcoin basics?}


\subsection{Design goals of a cryptocurrency P2P network}

BitTorrent remains the primary example of a computer network which no one was able to fully stop.
Despite multiple lawsuits against large torrent trackers, such as the Pirate Bay, as well as against regular users, law enforcers were unable to stop BitTorrent.
One may argue that this is impossible in principle: BitTorrent is just a protocol, in other words -- a language.
As long as the specifications are widely available, and there are two computers in the world willing to communicate according to its rules, BitTorrent is not dead.

This resiliency makes it similar to Bitcoin.
However, Bitcoin is not \textit{only} a set of rules -- it is a protocol that maintains specific \textit{state}.
While BitTorrent is agnostic to the format and semantics of the date being shared, Bitcoin's P2P layer is intended to share a concrete dataset -- the blockchain -- specific to the system at large.
This in the reason behind important distinctions between the design goals of a file-sharing networks (exemplified by BitTorrent for concreteness) and a cryptocurrency, exemplified by Bitcoin.


\subsubsection{Blockchain as a common dataset}

BitTorrent has no global state.
Users wishing to download a file join a \textit{swarm} of users who have (at least parts of) this file and have no interest in how other files are shared.

The goal of Bitcoin's P2P network is to share the single global state of the system.
The series of confirmed blocks contains the single source of truth on which key controls how many bitcoin.
Each user is interested in obtaining this dataset.
If Bob is expecting Alice to send him a payment for goods or services, he wants to make sure that she is not cheating.
To ensure that the received coins are genuine, Bob must check that they originate from a transaction in a confirmed block, and that transaction links back to another confirmed transactions, and so on, until the coinbase transactions that brought the coin to life by rewarding a miner.
Bob can only do so if he has the full dataset of all transactions that happened since the launch of the system.
(It is possible to get weaker assurances by performing simplified verification, but we omit these details for clarity.)

Sharing one global state means that content addressing is not a problem in Bitcoin.
There is no question about who has the required file, because every (full) node has it.

BitTorrent file-sharing is bounded in time: a user downloads a file, and leaves the network.
In contrast, cryptocurrency P2P networks perform constant synchronization, as new transactions and block are being generated.
Moreover, mining and non-mining nodes have different requirements regarding synchronization.



\subsubsection{Logical properties of blockchain data}

BitTorrent is agnostic to the semantics or format of the files being shared.
In Bitcoin, the data has a logical order: each block depends on the previous block.
A Bitcoin node (assuming the most conservative threat model) should download the blockchain sequentially, verifying every block.

The task of blockchain synchronization can be divided into two tasks: the initial blockchain download (IBD) and the ongoing synchronization.
These tasks have different requirements for two types of users: miners and non-mining nodes.

\paragraph{Miners and non-miners}
Satoshi Nakamoto initially envisioned a network where every node could participate in mining, or coin generation.
Early versions of Bitcoin reference implementation included an option to generate coins.
But the economic forces quickly lead to mining specialization, and since 2013 mining is a highly specialized business requiring large capital investment~\cite{Kroll2013}.
This lead to two informal protocol roles emerging.
Despite not having any special privileges encoded in the protocol, mining nodes have other requirements to the P2P protocol.
We will outline the differences in the next paragraph with respect to blocks and other message types.
 
\paragraph{Syncing blocks}
A node performs IBD when it reconnects to the network after a period of absence, or when connecting for the first time.
This task is relatively similar to the BitTorrent setting, in that there is a finite dataset to pull from a set of peers.
In BitTorrent, files are split into chunks, which are downloaded in parallel from different peers.
The order in which the chunks are downloaded is not fixed (though in some clients a user can prioritize first chunks of a video file to start watching it while later chunks are still being fetched).
In Bitcoin, on the other hand, blocks have a logical structure.
Downloading later blocks without ensuring the validity of earlier blocks is a risk: if an early blocks turns out to be invalid, all blocks dependent on it are invalid as well.
Therefore, in the most basic implementation, a Bitcoin node downloads and validates blocks sequentially.
This process has been optimized in 2015 (Bitcoin~Core~10.0.0) with \textit{headers-first} download~\cite{Core2015}.

Mining and non-mining nodes have different requirements on the speed of block synchronization.
Miners want to ensure that they get new blocks as fast as possible, and that the block they mine propagate to other miners quickly.
Mining on top of an outdated block, or letting one's block get orphaned by another simultaneously mined block, leads to direct financial losses\footnote{There is a counter-intuitive strategy of not immediately broadcasting a newly found block (selfish mining~\cite{Eyal2018}), put even selfish miners presumably want be technically able to broadcast and fetch blocks as quickly as possible to keep their options open.}.
This lead to optimizations of block propagation (such as \textit{compact blocks}~\cite{Core2016}) and the emergence of dedicated physical lines for very fast block dissemination among miners~\cite{FALCON, FIBRE}.
Non-mining nodes generally can tolerate a latency of a few seconds (much smaller than an average block interval of ten~minutes), so they use the regular Bitcoin P2P network.
	

\paragraph{Exchanging transactions and other messages}
Apart from blocks, the Bitcoin P2P protocol disseminates other types of messages, such as unconfirmed transactions and address messages.
In contrast to confirmed blocks, there is no canonical set of unconfirmed transactions.
Each node has its own version of this set (the \textit{mempool}).
Other protocol messages also do not need to be disseminated among all nodes very quickly.

Despite the fact that most wallets show an incoming transaction as soon as it is broadcast in the network, from the protocol point of view unconfirmed transactions are not secure.
Therefore, strictly speaking, non-mining nodes are only interested in receiving blocks, but not individual unconfirmed transactions.
They are, however, interested in broadcasting their transactions to miners quickly to get them mined.
Miners, on the other hand, need to receive unconfirmed transactions quickly to be able to include them in blocks and earn the associated fees.



\subsubsection{Incentives and privacy}

While many BitTorrent seeders are profit-driven~\cite{Rumin2010}, their rewards do not come from the protocol directly.
While the P2P protocol accounts for the actual bandwidth and assigns a higher internal weight to peers with fast and reliable connections, such in-protocol points are hard to convert into more conventional value systems.
Some torrent trackers employ reputation systems, where the tracker gives additional privileges to active seeders, but torrent seeders have been largely altruistic~\cite{Rehn2004}.
In file-sharing, nodes seldom have incentives to lie.
As a user knows the hash of the content they search for in advance, it is impossible to violate the integrity of the file\footnote{It is possible to distribute malicious content (i.e.,~via \textit{poisoned} torrents~\cite{Lou2006}) but its harmful properties manifest itself outside of the file-sharing protocol.}.


Bitcoin is powered by economic incentives.
Nevertheless, sharing blockchain data is not incentivized directly.
Nodes get no reward for propagating data to their peers.

We distinguish three requirements for a blockchain P2P layer based on tasks a user may wish to perform.
Namely, a user may wish to read the blockchain, write to the blockchain (i.e.,~send transactions), and prevent others from observing these interactions (privacy).

\paragraph{Reading the blockchain}
In cryptocurrencies, propagating false data may be a part of an attack.
An adversary eclipsing a victim with nodes under their control may make them believe that a different state of the blockchain is valid, compared to what the larger world is agreeing upon.

Bitcoin's proof-of-work makes it difficult for an adversary to feed a fake blockchain to a user: malicious blocks must also contain a valid proof-of-work that is expensive to generate.
Eclipsing can facilitate other attacks, including ones on privacy.
To prevent this, Bitcoin and other cryptocurrencies deliberately choose neighbors randomly from a large set of possibly live nodes, and additional checks ensure network diversity among one's neighbors, ensuring that not too many neighbors are from the same subnet, as evident from their IP addresses.
Compare this to file-sharing, which optimizes for an opposite outcome: for instance re-trackers allow users to connect to peers in their immediate physical proximity, achieving faster downloads by using their ISP's internal infrastructure instead of the global Internet~\cite{Yoshida2012,Wang2012}.

\paragraph{Writing to the blockchain}
Arguably the most important quality that Bitcoin and other decentralized cryptocurrencies provide is censorship resistance.
In contrast to centralized banking, where clients are often subject to arbitrary account freezes or are not allowed to open an account in the first place, it is (or at least should be) very hard to prevent a cryptocurrency user from spending their coins.
In the most extreme scenario, censorship becomes a form of theft: despite having the private keys, a user would essentially lose coins.
Luckily, complete censorship is hard to perform\footnote{Assuming a non-custodial wallet, i.e.,~the user holding their own private keys.}.
Even if a user's node is eclipsed, they can sign a transaction and broadcast it without directly talking to the Bitcoin P2P network, using a third-party web service such as~\cite{Blockstream} (which can be accessed through Tor).

\paragraph{Privacy}
The lack of privacy in BitTorrent enabled tracking its users.
Though mass surveillance and prosecution of users engaged in file-sharing is technically possible, there are not too much incentives to do so.
The major reason why the share of P2P file-sharing traffic on the Internet has fallen sharply since early 2000s was the emergence of centralized streaming services that ultimately provided a better user experience legally and for a reasonable price\footnote{However, the proliferation of streaming services and the fragmentation of content between them has lead to a rise in BitTorrent usage in late 2010s~\cite{Bode2018}.} rather than law enforcement.
This trend suggests that privacy is not of crucial importance for P2P file-sharing.

For money, however, privacy is a crucial property.
In addition to ethical opposition to surveillance enabled by centralized digital payment systems, the requirement for privacy is motivated by the fact that a good currency has fungibility.
Each monetary unit should be valued the same as any other.
If this is not the case, a currency fails to implement its major function as a unit of account, as economic agents waste resources applying discounts for their incoming payments based the origin of concrete coins involved.
The ultimate way to enable fungibility is to make coins technically indistinguishable.
Bitcoin does a relatively poor job at that, as the transaction graph is public and saved in the blockchain.
The fact that Bitcoin addresses are not linked to real-world identities and can be generated anew for every transaction provides only a weak protection.
This design decision was motivated by a simple observation that, in the absence of a trusted third party, "[t]he only way to confirm the absence of a transaction is to be aware of all transactions"~\cite{Nakamoto2008}.
Novel cryptographic algorithms (zero-knowledge proofs) have been developed since that might allow to alleviate this limitation, but they remain experimental and unlikely to be incorporated in Bitcoin in the foreseeable future (while other cryptocurrencies, such as Zcash~\cite{BenSasson2014}, take advantage of them).

Keeping all these considerations in mind, in the next Section we outline the design of Bitcoin's P2P networking protocol.



\section{Our contributions}
\label{sec:C02_S4_Our_Contributions}

In the next Chapter, we present our contributions towards better understanding of privacy of Bitcoin and other cryptocurrencies on the networking layer.
\todo{add Refs to chapters}

First, we explore the scenario of a global passive adversary.
We tackle the following question: can an adversary infer relationships between transactions based solely on their propagation pattern in the network?
We review the Bitcoin's P2P protocol and propose an algorithm that allows us to distinguish transactions issued from the same node from transactions issued from different nodes (with s certain degree of accuracy).
We implement and test our method on Bitcoin and three other cryptocurrencies focused on privacy: Dash, Monero, and Zcash.
We also test the same technique on transactions issued from mobile wallets, which are studied in more detail in the subsequent chapter.

Then, we study mobile wallets.
With smartphones vastly outnumbering desktops and laptops and being the primary or only computing device for hundreds of millions of people.\todo{add cite}
The security of cryptocurrency wallets is therefore of high importance.
We systematize various privacy-related characteristics of mobile applications that are relevant for cryptocurrency wallets, and compare a selection of \missing{XX} wallets for Android -- the most prevalent mobile OS.
Our results show that the majority of wallets do not follow all security and privacy guidelines.

